{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-white p-8 rounded-lg shadow">
    <h2 class="text-2xl font-bold mb-6">สร้างรายการเบิกเหล็ก</h2>

    <form method="post">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field in form %}
            <div class="{% if field.name == 'note_1' %}md:col-span-2{% endif %}">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ field.label }}
                    {% if field.field.required %}
                    <span class="text-red-500">*</span>
                    {% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}
                <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                {% endif %}
                {% if field.errors %}
                <p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="mt-8 flex justify-end gap-3">
            <a href="{% url 'coil:coilout_list' %}"
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded">
                ยกเลิก
            </a>
            <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">
                บันทึก
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const coilSelect = document.getElementById('id_coil_number');
            const skuSelect = document.getElementById('id_sku');

            if (coilSelect && skuSelect) {
                // Store original SKU select HTML to restore if needed
                const originalSkuHTML = skuSelect.innerHTML;

                coilSelect.addEventListener('change', function() {
                    const coilId = this.value;

                    if (coilId) {
                        // Show loading state
                        skuSelect.disabled = true;
                        const currentValue = skuSelect.value;
                        skuSelect.innerHTML = '<option value="">กำลังโหลด...</option>';

                        // Build URL with correct path including 'coil' prefix
                        const url = `/api/get-sku/${coilId}/`;
                        console.log('Fetching SKU from:', url);

                        fetch(url)
                            .then(response => {
                                console.log('Response status:', response.status);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Received data:', data);
                                // Restore original options
                                skuSelect.innerHTML = originalSkuHTML;
                                skuSelect.disabled = false;

                                if (data.sku_id) {
                                    // Set the SKU value
                                    skuSelect.value = data.sku_id;
                                    console.log('SKU auto-filled:', data.sku_name);
                                } else if (data.error) {
                                    console.error('Error from server:', data.error);
                                    alert('ไม่สามารถดึงข้อมูล SKU ได้: ' + data.error);
                                }
                            })
                            .catch(error => {
                                // Restore original options on error
                                skuSelect.innerHTML = originalSkuHTML;
                                skuSelect.disabled = false;
                                console.error('Error fetching SKU:', error);
                                alert('เกิดข้อผิดพลาดในการดึงข้อมูล SKU: ' + error.message);
                            });
                    } else {
                        // Clear SKU if no coil selected
                        skuSelect.value = '';
                    }
                });
            } else {
                console.error('Could not find coil_number or sku select elements');
            }
        });
    </script>
</div>
{% endblock %}
