{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-white p-8 rounded-lg shadow">
    <h2 class="text-2xl font-bold mb-6">สร้างรายการเบิกเหล็ก</h2>

    <form method="post">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field in form %}
            <div class="{% if field.name == 'note_1' %}md:col-span-2{% endif %}">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ field.label }}
                    {% if field.field.required %}
                    <span class="text-red-500">*</span>
                    {% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}
                <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                {% endif %}
                {% if field.errors %}
                <p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="mt-8 flex justify-end gap-3">
            <a href="{% url 'coil:coilout_list' %}"
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded">
                ยกเลิก
            </a>
            <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">
                บันทึก
            </button>
        </div>
    </form>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- jQuery & Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* Custom Select2 Styling to match Tailwind */
        .select2-container .select2-selection--single {
            height: 42px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 6px 12px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
            color: #111827; /* gray-900 */
        }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
    </style>

    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('#id_coil_number').select2({
                placeholder: 'ค้นหาหมายเลขม้วน',
                allowClear: true,
                width: '100%'
            });

            // Ensure vanilla JS change listener catches Select2 changes
            $('#id_coil_number').on('change', function() {
                this.dispatchEvent(new Event('change'));
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Flatpickr
            flatpickr(".datetimepicker", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                allowInput: true
            });

            const coilSelect = document.getElementById('id_coil_number');
            const skuSelect = document.getElementById('id_sku');
            const fullPartialSelect = document.getElementById('id_full_coil_partial');
            const weightInput = document.getElementById('id_coil_kg');
            let activeCoilWeight = 0;

            // Job Auto-fill Logic
            const jobNumberSelect = document.getElementById('id_job_number');
            const jobNameInput = document.getElementById('id_job_name_short');
            const jobQtyInput = document.getElementById('id_job_qty');
            const departmentSelect = document.getElementById('id_department_cutting');
            const coilKgInput = document.getElementById('id_coil_kg');
            const type0Input = document.getElementById('id_type0');

            if (jobNumberSelect) {
                 // Initialize Select2 for Job Number if not already (assuming new field isn't auto-inited by older code)
                 $(jobNumberSelect).select2({
                    placeholder: 'ค้นหาเลขงาน',
                    allowClear: true,
                    width: '100%'
                });

                $(jobNumberSelect).on('change', function() {
                    this.dispatchEvent(new Event('change'));
                });

                jobNumberSelect.addEventListener('change', function() {
                    const jobId = this.value;
                    if (jobId) {
                        // Build URL - no /coil/ prefix needed since coil urls are at root
                        const url = `/api/get-job-details/${jobId}/`;
                        console.log('Fetching job details from:', url);

                        fetch(url)
                            .then(response => {
                                console.log('Job details response status:', response.status);
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                    }).catch(() => {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Job details received:', data);
                                if (data.error) {
                                    console.error('Error fetching job:', data.error);
                                    alert('ไม่สามารถดึงข้อมูลงานได้: ' + data.error);
                                } else {
                                    if (jobNameInput) jobNameInput.value = data.job_name_short || '';
                                    if (jobQtyInput) jobQtyInput.value = data.job_qty || '';
                                    if (departmentSelect && data.department_id) {
                                        departmentSelect.value = data.department_id;
                                        console.log('Department auto-filled:', data.department_id);
                                    } else if (departmentSelect) {
                                        departmentSelect.value = ''; // Reset if not found
                                    }
                                    // Auto-fill น้ำหนัก (kg) และ ประเภท from Job
                                    if (coilKgInput && data.coil_kg) {
                                        coilKgInput.value = data.coil_kg;
                                        console.log('Coil kg auto-filled:', data.coil_kg);
                                    }
                                    if (type0Input && data.type0) {
                                        type0Input.value = data.type0;
                                        console.log('Type0 auto-filled:', data.type0);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching job details:', error);
                                alert('เกิดข้อผิดพลาดในการดึงข้อมูลงาน: ' + error.message);
                            });
                    } else {
                        // Clear all fields when no job is selected
                        if (jobNameInput) jobNameInput.value = '';
                        if (jobQtyInput) jobQtyInput.value = '';
                        if (departmentSelect) departmentSelect.value = '';
                        if (coilKgInput) coilKgInput.value = '';
                        if (type0Input) type0Input.value = '';
                    }
                });
            }

            if (coilSelect && skuSelect) {
                // Store original SKU select HTML to restore if needed
                const originalSkuHTML = skuSelect.innerHTML;

                function updateWeightLogic() {
                    if (!activeCoilWeight) return;
                    
                    const mode = fullPartialSelect.value;
                    if (mode === 'เต็มม้วน') {
                        weightInput.value = activeCoilWeight;
                        weightInput.readOnly = true; // Optional: lock it? User said "pull value", maybe editable? Plan said auto-fill. ReadOnly is safer for "Full".
                        // Remove validity error if any
                        weightInput.setCustomValidity('');
                    } else if (mode === 'บางส่วน') {
                        weightInput.readOnly = false;
                        // specific validation logic is in checkWeightLimit
                    } else {
                        weightInput.readOnly = false;
                        weightInput.value = '';
                    }
                    checkWeightLimit(); // Re-check limit after mode change
                }

                function checkWeightLimit() {
                    if (!activeCoilWeight || fullPartialSelect.value !== 'บางส่วน') {
                         weightInput.setCustomValidity('');
                         return;
                    }
                    
                    const currentWeight = parseFloat(weightInput.value);
                    if (isNaN(currentWeight) || currentWeight <= 0) {
                        weightInput.setCustomValidity('กรุณากรอกน้ำหนักที่ถูกต้อง');
                        weightInput.reportValidity();
                    } else if (currentWeight > activeCoilWeight) {
                        weightInput.setCustomValidity(`น้ำหนักเกิน! น้ำหนักม้วนจริงคือ ${activeCoilWeight} กก.`);
                        weightInput.reportValidity();
                    } else {
                        weightInput.setCustomValidity('');
                    }
                }

                if (fullPartialSelect) {
                    fullPartialSelect.addEventListener('change', updateWeightLogic);
                }
                
                if (weightInput) {
                    weightInput.addEventListener('input', checkWeightLimit);
                }

                coilSelect.addEventListener('change', function() {
                    const coilId = this.value;

                    if (coilId) {
                        // Show loading state
                        skuSelect.disabled = true;
                        const originalSkuText = skuSelect.options[skuSelect.selectedIndex]?.text; // Keep current if valid? No, usually loading.
                        skuSelect.innerHTML = '<option value="">กำลังโหลด...</option>';

                        // Build URL - no /coil/ prefix needed since coil urls are at root
                        const url = `/api/get-sku/${coilId}/`;
                        console.log('Fetching SKU from:', url);

                        fetch(url)
                            .then(response => {
                                console.log('Response status:', response.status);
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                    }).catch(() => {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Received data:', data);
                                // Restore original options
                                skuSelect.innerHTML = originalSkuHTML;
                                skuSelect.disabled = false;

                                if (data.sku_id) {
                                    // Set the SKU value
                                    skuSelect.value = data.sku_id;
                                    console.log('SKU auto-filled:', data.sku_name);
                                } 
                                
                                if (data.weight) {
                                    activeCoilWeight = parseFloat(data.weight);
                                    console.log('Coil Weight:', activeCoilWeight);
                                    updateWeightLogic(); // Update immediately if mode is already selected
                                } else {
                                    activeCoilWeight = 0; // Reset if no weight data
                                    weightInput.value = '';
                                    weightInput.readOnly = false;
                                }

                                if (data.error) {
                                    console.error('Error from server:', data.error);
                                    alert('ไม่สามารถดึงข้อมูล SKU ได้: ' + data.error);
                                }
                            })
                            .catch(error => {
                                // Restore original options on error
                                skuSelect.innerHTML = originalSkuHTML;
                                skuSelect.disabled = false;
                                console.error('Error fetching SKU:', error);
                                alert('เกิดข้อผิดพลาดในการดึงข้อมูล SKU: ' + error.message);
                                activeCoilWeight = 0; // Reset on error
                                weightInput.value = '';
                                weightInput.readOnly = false;
                            });
                    } else {
                        // Clear SKU and weight if no coil selected
                        skuSelect.value = '';
                        activeCoilWeight = 0;
                        weightInput.value = '';
                        weightInput.readOnly = false; // Ensure it's editable if no coil
                        weightInput.setCustomValidity(''); // Clear any validation
                    }
                });
            } else {
                console.error('Could not find coil_number or sku select elements');
            }
        });
    </script>
</div>
{% endblock %}
